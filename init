#!/bin/bash
set -euo pipefail

# ----------------------------------------
# ðŸ› ï¸ Config Directory Setup
# ----------------------------------------

CONFIG_ROOT="${1:-$HOME/.config/backup-kit}"
MACHINE_ID="$(hostname -s)"
ENV_FILE="$CONFIG_ROOT/env/$USER@${MACHINE_ID}_.env"
REPO_ENV_LINK="$(dirname "$0")/config/backup.env"

# ----------------------------------------
# ðŸ”§ Create Placeholder If Missing
# ----------------------------------------

if [[ ! -f "$ENV_FILE" ]]; then
  echo "âš ï¸  Environment file not found: $ENV_FILE"
  echo "ðŸ“„ Creating placeholder environment file..."

  mkdir -p "$(dirname "$ENV_FILE")"
  cat > "$ENV_FILE" <<EOF
# $ENV_FILE

# ============================
# Core backup-kit environment
# ============================

# Optional: override default config path
# CONFIG_DIR="\$HOME/.config/backup-kit"

# ============================
# User-defined toggle section
# ============================

REMOTE_USER="$USER"
REMOTE_SERVER="example-server"

# ============================
# Base backup paths
# ============================

LOCAL_DEST_DIR="\$HOME/Backup/${MACHINE_ID}_backup"
REMOTE_DEST_DIR="/remote/backup/path"
ARCHIVE_SUBDIR="archive"

# ============================
# Core backup flags
# ============================

DRY_RUN=true  # Set to false to enable actual syncing

# ============================
# Target definitions
# ============================

LOCAL_TARGET_BASE="\$LOCAL_DEST_DIR"
REMOTE_TARGET_BASE="\$REMOTE_USER@\$REMOTE_SERVER:\$REMOTE_DEST_DIR"

LOCAL_ARCHIVE_BASE="\$LOCAL_TARGET_BASE/\$ARCHIVE_SUBDIR"
REMOTE_ARCHIVE_BASE="\$REMOTE_TARGET_BASE/\$ARCHIVE_SUBDIR"
EOF

  echo "âœ… Placeholder created at: $ENV_FILE"
  echo "âš™ï¸  Please customize it before running backups."
  exit 1
fi

# ----------------------------------------
# ðŸ”— Link Env File to Repo
# ----------------------------------------

ln -sf "$ENV_FILE" "$REPO_ENV_LINK"
echo "ðŸ”— Linked backup.env â†’ $ENV_FILE"

